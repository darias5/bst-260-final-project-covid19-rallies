---
title: "BST 260 - Final Project"
subtitle: "In-person Presidential campaign rallies and trends in country-level COVID-19 cases and deaths"
authors: "Daniel Arias, Kritika Anand, and Tianxiao Zhao"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r echo=FALSE}

## Load Libraries
library(tidyverse)
library(dplyr)
library(lubridate)
library(foreach)
library(ggplot2)
library(maps)
library(viridis)
library(zoo)
library(readxl)
library (MatchIt)

## Directory and file paths 
#path <- "~/3. PhD/Y2/Fall/BST 260/bst-260-final-project-covid19-rallies/"
#path <- "C:/Users/kriti/OneDrive - Harvard University/HSPH Semester/Semester 3/BST 260/Final Project/Final Project/bst-260-final-project-covid19-rallies/"
# path <- "/Users/zhaotianxiao/Desktop/BST 260/Final Project/bst-260-final-project-covid19-rallies/"
path <- "~/3. PhD/Y2/Fall/BST 260/bst-260-final-project-covid19-rallies/"
outputpath <- paste(path,'results/', sep = "/")
datapath <- paste(path,'data/', sep = "/")

```

**Overview and Motivation**

In-person rallies are large events and may contribute to the spread of COVID-19; in many jurisdictions in the United States, large gatherings have been prohibited or are regulated to promote social distancing and reduce the transmission of COVID-19, and the federal government has issued guidance underscoring the risk large events pose when social distancing may not be readily enforceable. In the lead-up to the November 3 2020 Presidential election, President Trump conducted numerous in-person rallies, both before and after the White House COVID-19 outbreak of September-October 2020. In the 30 days prior to the election, President Trump held 45 in-person rallies across multiple states (Vice President Biden has held numerous drive-in rallies during the same period). Given social distancing guidelines and numerous COVID-19 diagnoses among the President’s re-election campaign (including the President himself), numerous public health researchers, professionals, and observers have raised concerns that the President’s in-person rallies may be contributing to the spread of COVID-19.

Conflicting investigations and working papers have suggested that rallies are and are not associated with local spikes in COVID-19 transmission (Dave et al 2020; Bernheim et al 2020). Motivated by the urgency of the COVID-19 pandemic and the saliency of whether in-person rallies may be associated with excess cases and mortality, we are interested in using time-series data on county-level COVID-19 cases and deaths to visualize trends in transmission in counties in which in-person campaign rallies were hosted and to compare these counties to others in which in-person events were not held. We hope that this analysis will provide additional information on the potential impacts and risks of in-person rallies, encouraging safer measures and accountability for activites that pose risk to the public.

Project Objectives

Research goals: To examine whether the presence of a Trump rally in a county was associated with a significant change in the trend of COVID-19 cases and deaths in the ensuing period, compared to similar regions that did not host rallies

Academic goals: Learn more about how COVID data is collected, organized, and reported Learn about the selection of controls in observational studies and the implications for drawing causal inferences Learn about different strategies for visualizing time-series data and testing for discontinuities

Implications: Increases in COVID-19 cases and deaths that are potentially attributable to political rallies would underscore the importance of social distance guidelines

Optional features: Choice of control -- propensity score matching, synthetic controls

**Related Work**

Two major working papers concerning rallies and COVID-19 transmission are Dave et al. 2020 and Bernheim et al. 2020. The papers reach opposing conclusions, motivating our investigation. 

The working paper by Dave and colleagues presents an in-depth inquiry of one presidential campaign rally held by President Trump on June 20, 2020 at the Bank of Oklahoma arena in Tulsa, Oklahoma. The investigators were able to use mobility data to investigate whether non-resident visits to the county increased due to the rally, and whether social distancing behaviors changed among the resident population. The investigators found that while non-resident visitors increased by 25%, social distancing among residents did not attenuate. Using synthetic controls and difference-in-difference, the investigators argue that there was no statistically significant increase in COVID-19 cases associated with the rally.

Bernheim et al., in contrast, explores 18 rallies, matching each to similar counties that did not hold rallies. Counties were matched using 24 different procedures, using regression models that included demographic characteristics, trajectory of cases, and post-event outcomes. The analysis suggests that the average treatment effect associated with hosting a rally likely increased COVID-19 cases by more than 250 per 100,000 people. Extrapolating the the whole sample, Bernheim and colleagues suggest that the 18 rallies resulted in 30,000 additional COVID-19 cases and 700 excess deaths.

Our approach is chiefly inspired from these two papers, further inspired by our courses' discussion of time-series infectious disease data and choropleth design. Our analysis echoes many of the assignments and in-class demonstrations conducted in the course modules on Data Visualization and Shiny app design.

**Initial Questions**

* Is there a geographic overlap in locations of counties and locations of increased COVID-19 cases, in and around counties that held rallies? 
* Did COVID-19 cases increase in counties that held rallies over the subsequent 3 weeks?
* Were counties that held rallies experiencing different levels of COVID-19 cases and deaths (prior to rallies) than comparable counties that did not hold rallies?
* Was the presence of a Trump rally in a county associated with a significant change in the trend of COVID-19 cases and deaths in the ensuing period, compared to similar counties that did not host rallies?

**Data**

Our data were collected from the following sources:

* COVID-19 case and death data at the county-level were collected from the Center for Systems Science and Engineering, Johns Hopkins University: https://github.com/CSSEGISandData/COVID-19

* Exposure data (location and date of rallies) were compiled manually from https://en.wikipedia.org/wiki/List_of_post-election_Donald_Trump_rallies, and were verified against the campaign's posted schedule (https://www.donaldjtrump.com/events/) and composites of the President's official schedule (https://factba.se/topic/calendar). 

* Median income of counties in 2018 data were obtained from the Economic Research Service of the U.S. Department of Agriculture: https://www.ers.usda.gov/data-products/county-level-data-sets/ 

* County land area size data (used to calculate population density) were obtained from the U.S. Census Bureau: https://www.census.gov/library/publications/2011/compendia/usa-counties-2011.html

We joined county data sets using Federal Information Processing Standard (FIPS) codes, rather the county names, in order to use a standardized referencing system that would minimize the risk of errors and incomplete joins. Each county in the U.S. is assigned a FIPS code, which encodes both the state the county is in as well as the county itself, based on the intigers used in the code. The complete FIPS codes for counties can be found at the U.S Department of Agriculture: https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697. 

## Step 1: Prepare COVID-19 Data

*COVID-19 data were filtered to exclude American territories and cruise ships, as well as unassigned cases/deaths and blank entries for FIPS.*

```{r}

## Step 1a: Import Case Dataset 
cases <- read_csv(file = file.path(datapath,"time_series_covid19_confirmed_US.csv")) %>%
  mutate(state_fips = as.numeric(substr(FIPS,1,2))) %>%
  mutate(county_fips = as.numeric(substr(FIPS,3,5))) %>%
  mutate(fips = as.numeric(FIPS)) %>%
  drop_na(fips) %>%
  select(-UID, -iso2, -iso3, -code3, -Country_Region, -FIPS) %>%
  filter(Province_State != "American Samoa", 
         Province_State != 'Puerto Rico',
         Province_State != "Guam", 
         Province_State != "Northern Mariana Islands", 
         Province_State != "Virgin Islands", 
         Province_State != 'Diamond Princess', 
         Province_State != 'Grand Princess', 
         Admin2 != "Unassigned") %>% 
  rename(county_name = Admin2, 
         state_name = Province_State, 
         lat = Lat, 
         long = Long_, 
         full_name = Combined_Key ) %>%
  pivot_longer(contains("/"), names_to = "date", values_to = "cases") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))

## Step 1b: Import Death Dataset 
deaths <- read_csv(file = file.path(datapath,"time_series_covid19_deaths_US.csv")) %>%
  mutate(fips = as.numeric(FIPS)) %>%
  drop_na(fips) %>%
  filter(Province_State != "American Samoa", 
         Province_State != 'Puerto Rico',
         Province_State != "Guam", 
         Province_State != "Northern Mariana Islands", 
         Province_State != "Virgin Islands", 
         Province_State != 'Diamond Princess', 
         Province_State != 'Grand Princess',
         Admin2 != "Unassigned") %>% 
  select(-UID, -iso2, -iso3, -code3, -Country_Region, -FIPS, -Lat, -Long_, -Province_State, -Combined_Key, -Admin2) %>%
  pivot_longer(contains("/"), names_to = "date", values_to = "deaths") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))

## Step 1c: Merge the data together 
df <- cases %>%
  left_join(deaths, by = c('fips','date')) %>%
  arrange(fips, date)
rm(cases, deaths)

## Step 1d: Load Median Income 
income <- read_csv(file = file.path(datapath,"ers-usda.csv")) %>%
  select(median_inc = Median_Household_Income_2018, fips = fips)

## Step 1e: Merge Median Income Info with Full Dataset
df <- df %>%
  left_join(income, by = c('fips'))

# Step 1f: Data cleaning
df <- df[-c(3:7)] # Cleaning data to drop columns that are not needed
df <- rename(df, "population" = "Population")
rm(income)

# Step 1g: Creating a variable that contains the number of new confirmed cases
df <- df %>% 
  arrange(date) %>% 
  group_by(fips)  %>% 
  mutate(new_cases = cases - lag(cases))

# Step 1h: Creating a rolling 7-day average for the number of new confirmed cases
df <- df %>% 
  arrange(date) %>% 
  group_by(fips) %>% 
  mutate(new_cases_7dayavg = rollmean(new_cases, k = 7, fill = NA))

# Step 1i: Creating a new variable that calculates the seven-day rolling average of new cases per million
df <- df %>% 
  mutate(new_cases_7dayavg_per_mil_cap = new_cases_7dayavg / population * 1000000)

# Step 1j: Creating a variable that contains the number of deaths
  df <- df %>% arrange(date) %>% 
  group_by(fips)  %>% 
  mutate(new_deaths = deaths - lag(deaths))

# Step 1k: Creating a rolling 7-day average for the number of new confirmed deaths
df <- df %>% 
  arrange(date) %>% 
  group_by(fips) %>% 
  mutate(new_deaths_7dayavg = rollmean(new_deaths, k = 7, fill = NA))

# Step 1l: Creating a new variable that calculates the seven-day rolling average of new deaths per million
df <- df %>% 
  mutate(new_deaths_7dayavg_per_mil_cap = new_deaths_7dayavg / population * 1000000)

# Step 1m: Merging in land area in square miles and creating density variable
land_area <- read_excel(path = file.path(datapath,"Land area by counties.xlsx"))
land_area$fips <- as.numeric(land_area$STCOU)
land_area$land_area <- land_area$LND110200D

df <- df %>% 
  left_join(land_area[,c(4,5)], by="fips") 
rm(land_area)
df <- df %>% 
  mutate(density = population/land_area)

```

## Step 2: Prepare Rally Data

*Note: FIPS codes were assigned based on the county in which the rally took place or the county containing the largest share of the nearest metropolitan area. For example, rallies held in airports near cities were coded to have taken place in the county containing the city, rather than the airport.*

```{r}

# Step 2a: Import rally data 
rally_data <- read_xlsx("../data/rallies_cc_da.xlsx") 
rally_data$date <- as.Date(rally_data$date)

# Step 2b: Filter out rallies that predate February 26, 2020 (first community spread in February 26)
rally_data <- rally_data %>%
  filter(date > ymd(200226)) %>%
  filter(date <= max(df$date)) %>%
  select(date, fips) %>%
  mutate(rally = 1)

# Step 2c: Full join rally and COVID-19 data by FIPS code
df <- df %>%
  full_join(rally_data, by = c("fips", "date")) %>%
  group_by(fips) %>%
  mutate(rally_ind = ifelse(sum(rally, na.rm = T) != 0, 1, 0))


# Step 2d: Create days-to-rally variables for rally 1 and rally 2
temp <- df %>%
  group_by(fips) %>%
  filter(sum(rally, na.rm = T) != 0) %>%
  mutate(day_to_rally_1 = date - date[which(rally == 1)][1]) %>%
  mutate(day_to_rally_2 = date - date[which(rally == 1)][2]) %>%
  select(date, fips, day_to_rally_1, day_to_rally_2)

# Step 2f: Join in mutated data and clean
df <- df %>%
  full_join(temp, by = c("fips", "date"))
df$rally <- NULL
rm(temp)
rm(rally_data)
```

Step 3: Prepare Map Data

*Note that Shannon County (FIPS 46113) was renamed to Oglala Lakota County (FIPS 46102) as of May 1st, 2015. We therefore replace FIPS code 46113 with the new code 46102.*

```{r}

# Step 3a: Downloading map data
us_map = map_data("county")
fips <- data.frame(county.fips)

# Step 3b: Update the renaming of Shannon County, SD to Ogala Lakota, SD
us_map$subregion[us_map$region == "south dakota" & us_map$subregion == "shannon"] <- "ogala lakota"
fips$fips[fips$fips == 46113] <- 46102
fips$polyname[fips$fips == 46102] <- "south dakota,ogala lakota"

# Step 3c: Merging data 
us_map$polyname <- paste(us_map$region, us_map$subregion, sep = ",")
us_map <- full_join(fips, us_map, by = "polyname")
rm(fips)

# Step 3d: Merging map data into dataframe
df <- full_join(df, us_map, by = c("fips"))
rm(us_map)

```


**Exploratory Analysis**

We began by visually analyzing our county-level data using heat maps of the United States, in order to identify patterns, missing data, and other issues in coding. Visually displaying the data using a heat map provided both an elegant way to quickly confirm data completeness as well as provide a general sense of the prevaling trends in population distribution, median income, and COVID-19 cases and deaths.

In the graphs below, we present the snapshot of the epidemic on Election Day 2020. To account for variation in day-to-day reporting, we further generated and conducted visual analysis of the 7-day rolling average of cases and deaths, and related both to the population size to provide for per-capita figures. The population-adjusted rolling averages would be used later in the final analysis.

```{r}

# Step 4a: Map of population
map_0 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = population/1000)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Total population, millions",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Population size") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1 million pop
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4b: Map of new confirmed COVID-19 cases per million people
map_1 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_cases_7dayavg_per_mil_cap)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 cases per million people",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1 thousand cases per million capita per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4c: Map of of new confirmed COVID-19 cases
map_2 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_cases_7dayavg)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 cases",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,150),    # Forcing upper limit of 150 cases per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# # Step 4d: Map of cumulative COVID-19 deaths
map_3 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = deaths)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of cumulative COVID-19 deaths",
        subtitle="as of November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Cumulative deaths") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1000 deaths
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# # Step 4e: Map of new confirmed COVID-19 deaths per million people
map_4 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_deaths_7dayavg_per_mil_cap)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 deaths per million people",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,100),    # Forcing upper limit of 100 deaths per million capita per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4f: Map of new confirmed COVID-19 deaths
map_5 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_deaths_7dayavg)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 deaths",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,10),    # Forcing upper limit of 100 deaths per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale


# Step 4g: Map of median income
map_6 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = median_inc)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Median income",
        caption="Source: USDA",
        fill="Household income, dollars") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,100000),    # Forcing upper limit of 1 million pop
                               oob = scales::squish) # Letting values out of bounds be squished to scale

map_0
map_1
map_2
map_3
map_4
map_5
map_6
```

our visual analysis confirmed that 

Step 5: Map of rally locations, sized by change in cases

```{r}
# Step 5a: Subset data of rallies

rally <- df %>% filter(rally_ind==1) 
df_singledata <- df %>% filter(date == "2020-11-03") 
rally <- rally 
rally <- rally %>% group_by(fips)  %>%
  summarize_at(vars(long, lat), ~mean(range(.)))
rally <- rally %>% rename("mean_long" = long, "mean_lat" = lat)
rally_covid_data <- df %>% select(1:19)
rally <- inner_join(rally, rally_covid_data, by = c("fips"))
rally <- rally %>% filter(day_to_rally_1 == -14 | day_to_rally_1 == 14) 
rally <- rally %>% distinct()
rally <- rally %>% arrange(date) %>%  group_by(fips)  %>% 
  mutate(delta_cases = cases - lag(cases))
rally <- rally %>% filter(!is.na(delta_cases))

# Step 5b: Map of cumulative COVID-19 cases per sq. mile and change in COVID-19 cases before vs. after rallies
map_7 <- df_singledata %>%
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group,  fill=cases/land_area), color = "grey") + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
    geom_point(data=rally, aes(x=mean_long, y=mean_lat, size = delta_cases), color="purple4", alpha=0.75) + 
        labs(title="Cumulative COVID-19 cases as of Election Day and rally locations",
        subtitle="Circles indicate change in COVID-19 cases in counties, 2 weeks after vs. before rally",
        size = "Increase in cases in rally counties",
        caption= "Source: Center for Systems Science and Engineering, Johns Hopkins University.",
        fill = " COVID-19 cases per sq. mile") +
    scale_fill_continuous(low = "white", high = "red", na.value = NA,
                          limits = c(0,5),    # Forcing upper limit of 1 thousand cumulative cases per million capita 
                               oob = scales::squish) # Letting values out of bounds be squished to scale

rm(df_singledata)
map_7


```

**Final Analysis**

Step 6: Mean-centered graphs of COVID-19 cases among counties with rallies

```{r}
# Step 6a: Boxplot of new cases based weighted on population density

p1 <- df %>%
  filter(rally_ind == 1) %>%
  filter(day_to_rally_1 %in% -21:21) %>%
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = mean(new_cases_7dayavg_per_mil_cap, na.rm = T)) %>%
  ggplot(aes(x = factor(day_to_rally_1),
             y = new_cases_7dayavg_per_mil_cap
             )) +
  geom_boxplot(fill = 'grey') +
  geom_vline(aes(xintercept = factor(0)),
                 colour = "red",
                 linetype = "dashed") +
  labs(title="Number of new confirmed COVID-19 cases per million people",
              subtitle = "Weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6b: Lineplot of new cases for the mean weighted on population density

p2 <- df %>%
  filter(rally_ind == 1) %>% # counties with rallies
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = weighted.mean(new_cases_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(day_to_rally_1, mean_cases) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6c: Boxplot of new deaths based weighted on population density

p3 <- df %>%
  filter(rally_ind == 1) %>%
  filter(day_to_rally_1 %in% -21:21) %>%
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = mean(new_deaths_7dayavg_per_mil_cap, na.rm = T)) %>%
  ggplot(aes(x = factor(day_to_rally_1),
             y = new_deaths_7dayavg_per_mil_cap
             )) +
  geom_boxplot(fill = 'grey') +
  geom_vline(aes(xintercept = factor(0)),
                 colour = "red",
                 linetype = "dashed") +
  labs(title="Number of new confirmed COVID-19 deaths per million people",
       subtitle = "Weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6d: Lineplot of new deaths for the mean weighted on population density

p4 <- df %>%
  filter(rally_ind == 1) %>% # counties with rallies
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = weighted.mean(new_deaths_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(day_to_rally_1, mean_cases) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 deaths per million people",
  subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") + ylim(0,4) +
  theme_bw()


p1
p2
p3
p4

```

Step 7: Propensity score matching

```{R}
# Step 7a: Propensity score matching based on median income and population density

score <- df %>% select(rally_ind,median_inc,density,fips)
score <- score %>% distinct()
score <- score %>% filter(!is.na(median_inc))
score <- score %>% filter(!is.na(density))
score <- score %>% filter(!is.infinite(density))

fit <- glm(rally_ind ~ median_inc + density, family="binomial" ,data=score)
summary(fit)

score$pr_score <- predict(fit, type = "response")

labs <- paste("County type:", c("Rally", "Control"))
score %>%
  mutate(rally_ind = ifelse(rally_ind == 1, labs[1], labs[2])) %>%
  ggplot(aes(x = pr_score)) +
  geom_histogram(color = "white") +
  facet_wrap(~rally_ind) +
  xlab("Probability of being a county with a rally") +
  theme_bw()

county_match <- matchit(rally_ind ~ median_inc + density , method ="nearest" ,data=score, replace = FALSE, ratio = 5)
dta_m <- match.data(county_match, subclass = "subclass")

summary(county_match)
dim(dta_m)

dta_m <- dta_m  %>% select(fips, subclass)
dta_m_1 <- inner_join(dta_m, df, by = c("fips"))


dta_m_2 <- dta_m_1  %>% select(day_to_rally_1, subclass, rally_ind, date)
dta_m_3 <- dta_m_2  %>% filter(rally_ind == 1)
dta_m_3 <- dta_m_3  %>% distinct()
dta_m_3 <- dta_m_3  %>% select(day_to_rally_1, subclass, date)


dta_m_1 <- dta_m_1 %>% select(c(1:18))%>% distinct()

dta_m <- full_join(dta_m_3, dta_m_1, by = c("subclass", "date"))

rm(dta_m_1)
rm(dta_m_2)
rm(dta_m_3)

```


Step 8: Mean-centered graphs of COVID-19 cases among counties with rallies vs. without

```{r}
# Step 8a:  Lineplot of new cases for the mean weighted on population density in case vs. control counties

p5_data <- dta_m %>%
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(rally_ind, day_to_rally_1) %>%
  mutate(mean_cases = weighted.mean(new_cases_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(rally_ind, day_to_rally_1, mean_cases) %>% 
  distinct() 

p5 <- p5_data %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases,
             color = as.factor(rally_ind))) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") 

p5

# Step 8b:  Lineplot of new cases, case vs. control counties

p6_data <- dta_m %>%
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  select(fips.y, rally_ind, day_to_rally_1, new_cases_7dayavg_per_mil_cap) %>% 
  group_by(fips.y)%>%
  distinct()

p6_data$al <- ifelse(p6_data$rally_ind == 1, 0.95, 0.90)

p6 <- p6_data %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = new_cases_7dayavg_per_mil_cap,
             group = fips.y,
             alpha = as.factor(rally_ind),
             color = as.factor(rally_ind))) +
    geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") +
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Counties with rallies and matched control counties",
    x = "Days until/after rally", 
    y = "Rolling 7-day average",
    color = "Rally or control (rally = 1)") +
  guides(alpha=F) + ylim(1,3000) + 
  scale_alpha_discrete(range = c(0.35, 0.9))


  
p6 

# # Step 8c:  Lineplot of difference in  cases, case vs. control counties

p7_data <- p5_data %>% 
  group_by(day_to_rally_1) %>%
  mutate(diff = mean_cases[which(rally_ind == 1)] - mean_cases[which(rally_ind == 0)]) %>% filter(rally_ind == 1)


p7 <- p7_data %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = diff
             )) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") + ylim(-10, 150) +
  geom_hline(aes(yintercept = 0),
             colour = "blue",
             linetype = "dashed") 

p7
  

```