---
title: "BST 260 - Final Project"
subtitle: "In-person Presidential campaign rallies and trends in country-level COVID-19 cases and deaths"
authors: "Daniel Arias, Kritika Anand, and Tianxiao Zhao"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{R}
knitr::opts_chunk$set(echo = TRUE)

```

To-Do List
1) Kritika -- add county fips numbers to rallies.csv -- https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697
2) Daniel -- loading updated rallies.csv to dataframe
3) Daniel -- fix choropleth data
4) All -- next week, work on centering time data around rallies (before and after), start visualizations of time series data

```{r}

## Load Libraries
library(tidyverse)
library(dplyr)
library(lubridate)
library(foreach)
library(ggplot2)
library(maps)
library(viridis)
library(zoo)
library(readxl)
library (MatchIt)


## Directory and file paths 
#path <- "~/3. PhD/Y2/Fall/BST 260/bst-260-final-project-covid19-rallies/"
#path <- "C:/Users/kriti/OneDrive - Harvard University/HSPH Semester/Semester 3/BST 260/Final Project/Final Project/bst-260-final-project-covid19-rallies/"
# path <- "/Users/zhaotianxiao/Desktop/BST 260/Final Project/bst-260-final-project-covid19-rallies/"
path <- "~/3. PhD/Y2/Fall/BST 260/bst-260-final-project-covid19-rallies/"
outputpath <- paste(path,'results/', sep = "/")
datapath <- paste(path,'data/', sep = "/")

```

## Step 1: Prepare COVID-19 Data

```{r}

## Step 1a: Import Case Dataset 
cases <- read_csv(file = file.path(datapath,"time_series_covid19_confirmed_US.csv")) %>%
  mutate(state_fips = as.numeric(substr(FIPS,1,2))) %>%
  mutate(county_fips = as.numeric(substr(FIPS,3,5))) %>%
  mutate(fips = as.numeric(FIPS)) %>%
  drop_na(fips) %>%
  select(-UID, -iso2, -iso3, -code3, -Country_Region, -FIPS) %>%
  filter(Province_State != "American Samoa", 
         Province_State != 'Puerto Rico',
         Province_State != "Guam", 
         Province_State != "Northern Mariana Islands", 
         Province_State != "Virgin Islands", 
         Province_State != 'Diamond Princess', 
         Province_State != 'Grand Princess', 
         Admin2 != "Unassigned") %>% 
  rename(county_name = Admin2, 
         state_name = Province_State, 
         lat = Lat, 
         long = Long_, 
         full_name = Combined_Key ) %>%
  pivot_longer(contains("/"), names_to = "date", values_to = "cases") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))


## Step 1b: Import Death Dataset 
deaths <- read_csv(file = file.path(datapath,"time_series_covid19_deaths_US.csv")) %>%
  mutate(fips = as.numeric(FIPS)) %>%
  drop_na(fips) %>%
  filter(Province_State != "American Samoa", 
         Province_State != 'Puerto Rico',
         Province_State != "Guam", 
         Province_State != "Northern Mariana Islands", 
         Province_State != "Virgin Islands", 
         Province_State != 'Diamond Princess', 
         Province_State != 'Grand Princess',
         Admin2 != "Unassigned") %>% 
  select(-UID, -iso2, -iso3, -code3, -Country_Region, -FIPS, -Lat, -Long_, -Province_State, -Combined_Key, -Admin2) %>%
  pivot_longer(contains("/"), names_to = "date", values_to = "deaths") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))

## Step 1c: Merge the data together 
df <- cases %>%
  left_join(deaths, by = c('fips','date')) %>%
  arrange(fips, date)
rm(cases, deaths)

## Step 1d: Load Median Income 
income <- read_csv(file = file.path(datapath,"ers-usda.csv")) %>%
  select(median_inc = Median_Household_Income_2018, fips = fips)

## Step 1e: Merge Median Income Info with Full Dataset
df <- df %>%
  left_join(income, by = c('fips'))

# Step 1f: Data cleaning
df <- df[-c(3:7)] # Cleaning data to drop columns that are not needed
df <- rename(df, "population" = "Population")
rm(income)

# Step 1g: Creating a variable that contains the number of new confirmed cases
df <- df %>% 
  arrange(date) %>% 
  group_by(fips)  %>% 
  mutate(new_cases = cases - lag(cases))

# Step 1h: Creating a rolling 7-day average for the number of new confirmed cases
df <- df %>% 
  arrange(date) %>% 
  group_by(fips) %>% 
  mutate(new_cases_7dayavg = rollmean(new_cases, k = 7, fill = NA))

# Step 1i: Creating a new variable that calculates the seven-day rolling average of new cases per million
df <- df %>% 
  mutate(new_cases_7dayavg_per_mil_cap = new_cases_7dayavg / population * 1000000)

# Step 1j: Creating a variable that contains the number of deaths
  df <- df %>% arrange(date) %>% 
  group_by(fips)  %>% 
  mutate(new_deaths = deaths - lag(deaths))

# Step 1k: Creating a rolling 7-day average for the number of new confirmed deaths
df <- df %>% 
  arrange(date) %>% 
  group_by(fips) %>% 
  mutate(new_deaths_7dayavg = rollmean(new_deaths, k = 7, fill = NA))

# Step 1l: Creating a new variable that calculates the seven-day rolling average of new deaths per million
df <- df %>% 
  mutate(new_deaths_7dayavg_per_mil_cap = new_deaths_7dayavg / population * 1000000)

# Step 1m: Merging in land area in square miles and creating density variable
land_area <- read_excel(path = file.path(datapath,"Land area by counties.xlsx"))
land_area$fips <- as.numeric(land_area$STCOU)
land_area$land_area <- land_area$LND110200D

df <- df %>% 
  left_join(land_area[,c(4,5)], by="fips") 
rm(land_area)
df <- df %>% 
  mutate(density = population/land_area)

```

## Step 2: Prepare Rally Data

```{r}

# Step 2a: Import rally data 
rally_data <- read_xlsx("../data/rallies_cc_da.xlsx") 
rally_data$date <- as.Date(rally_data$date)

# Step 2b: Filter out rallies that predate February 26, 2020 (first community spread in February 26)
rally_data <- rally_data %>%
  filter(date > ymd(200226)) %>%
  filter(date <= max(df$date)) %>%
  select(date, fips) %>%
  mutate(rally = 1)

# Step 2c: Full join rally and COVID-19 data by FIPS code
df <- df %>%
  full_join(rally_data, by = c("fips", "date")) %>%
  group_by(fips) %>%
  mutate(rally_ind = ifelse(sum(rally, na.rm = T) != 0, 1, 0))


# Step 2d: Create days-to-rally variables for rally 1 and rally 2
temp <- df %>%
  group_by(fips) %>%
  filter(sum(rally, na.rm = T) != 0) %>%
  mutate(day_to_rally_1 = date - date[which(rally == 1)][1]) %>%
  mutate(day_to_rally_2 = date - date[which(rally == 1)][2]) %>%
  select(date, fips, day_to_rally_1, day_to_rally_2)

# Step 2f: Join in mutated data and clean
df <- df %>%
  full_join(temp, by = c("fips", "date"))
df$rally <- NULL
rm(temp)
rm(rally_data)
```

Step 3: Prepare Map Data

*Note that Shannon County (FIPS 46113) was renamed to Oglala Lakota County (FIPS 46102) as of May 1st, 2015. We therefore replace FIPS code 46113 with the new code 46102.*

```{r}

# Step 3a: Downloading map data
us_map = map_data("county")
fips <- data.frame(county.fips)

# Step 3b: Update the renaming of Shannon County, SD to Ogala Lakota, SD
us_map$subregion[us_map$region == "south dakota" & us_map$subregion == "shannon"] <- "ogala lakota"
fips$fips[fips$fips == 46113] <- 46102
fips$polyname[fips$fips == 46102] <- "south dakota,ogala lakota"

# Step 3c: Merging data 
us_map$polyname <- paste(us_map$region, us_map$subregion, sep = ",")
us_map <- full_join(fips, us_map, by = "polyname")
rm(fips)

# Step 3d: Merging map data into dataframe
df <- full_join(df, us_map, by = c("fips"))
rm(us_map)

```

Step 4: Descriptive Visual Analysis

```{r}

# Step 4a: Map of population
map_0 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = population/1000)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Total population, millions",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Population size") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1 million pop
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4b: Map of new confirmed COVID-19 cases per million people
map_1 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_cases_7dayavg_per_mil_cap)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 cases per million people",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1 thousand cases per million capita per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4c: Map of of new confirmed COVID-19 cases
map_2 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_cases_7dayavg)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 cases",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,150),    # Forcing upper limit of 150 cases per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# # Step 4d: Map of cumulative COVID-19 deaths
map_3 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = deaths)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of cumulative COVID-19 deaths",
        subtitle="as of November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Cumulative deaths") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,1000),    # Forcing upper limit of 1000 deaths
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# # Step 4e: Map of new confirmed COVID-19 deaths per million people
map_4 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_deaths_7dayavg_per_mil_cap)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 deaths per million people",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,100),    # Forcing upper limit of 100 deaths per million capita per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale

# Step 4f: Map of new confirmed COVID-19 deaths
map_5 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = new_deaths_7dayavg)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Number of new confirmed COVID-19 deaths",
        subtitle="on November 3, 2020",
        caption="Source: Center for Systems Science and Engineering, Johns Hopkins University",
        fill="Rolling 7-day average") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,10),    # Forcing upper limit of 100 deaths per day
                               oob = scales::squish) # Letting values out of bounds be squished to scale


# Step 4g: Map of median income
map_6 <- df %>% filter(date == "2020-11-03") %>%
   ggplot(aes(x = long, y = lat, group = group, fill = median_inc)) +
      geom_polygon() + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
      labs(title="Median income",
        caption="Source: USDA",
        fill="Household income, dollars") +
   scale_fill_viridis_c(option = "plasma",
                               limits = c(0,100000),    # Forcing upper limit of 1 million pop
                               oob = scales::squish) # Letting values out of bounds be squished to scale

map_0
map_1
map_2
map_3
map_4
map_5
map_6
```

Step 5: Map of rally locations, sized by change in cases

```{r}
# Step 5a: Subset data of rallies

rally <- df %>% filter(rally_ind==1) 
df_singledata <- df %>% filter(date == "2020-11-03") 
rally <- rally 
rally <- rally %>% group_by(fips)  %>%
  summarize_at(vars(long, lat), ~mean(range(.)))
rally <- rally %>% rename("mean_long" = long, "mean_lat" = lat)
rally_covid_data <- df %>% select(1:19)
rally <- inner_join(rally, rally_covid_data, by = c("fips"))
rally <- rally %>% filter(day_to_rally_1 == -14 | day_to_rally_1 == 14) 
rally <- rally %>% distinct()
rally <- rally %>% arrange(date) %>%  group_by(fips)  %>% 
  mutate(delta_cases = cases - lag(cases))
rally <- rally %>% filter(!is.na(delta_cases))

# Step 5b: Map of cumulative COVID-19 cases per sq. mile and change in COVID-19 cases before vs. after rallies
map_7 <- df_singledata %>%
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group,  fill=cases/land_area), color = "grey") + 
      theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) +
    geom_point(data=rally, aes(x=mean_long, y=mean_lat, size = delta_cases), color="purple4", alpha=0.75) + 
        labs(title="Cumulative COVID-19 cases as of Election Day and rally locations",
        subtitle="Circles indicate change in COVID-19 cases in counties, 2 weeks after vs. before rally",
        size = "Increase in cases in rally counties",
        caption= "Source: Center for Systems Science and Engineering, Johns Hopkins University.",
        fill = " COVID-19 cases per sq. mile") +
    scale_fill_continuous(low = "white", high = "red", na.value = NA,
                          limits = c(0,5),    # Forcing upper limit of 1 thousand cumulative cases per million capita 
                               oob = scales::squish) # Letting values out of bounds be squished to scale

rm(df_singledata)
map_7


```

Step 6: Mean-centered graphs of COVID-19 cases among counties with rallies

```{r}
# Step 6a: Boxplot of new cases based weighted on population density

p1 <- df %>%
  filter(rally_ind == 1) %>%
  filter(day_to_rally_1 %in% -21:21) %>%
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = mean(new_cases_7dayavg_per_mil_cap, na.rm = T)) %>%
  ggplot(aes(x = factor(day_to_rally_1),
             y = new_cases_7dayavg_per_mil_cap
             )) +
  geom_boxplot(fill = 'grey') +
  geom_vline(aes(xintercept = factor(0)),
                 colour = "red",
                 linetype = "dashed") +
  labs(title="Number of new confirmed COVID-19 cases per million people",
              subtitle = "Weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6b: Lineplot of new cases for the mean weighted on population density

p2 <- df %>%
  filter(rally_ind == 1) %>% # counties with rallies
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = weighted.mean(new_cases_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(day_to_rally_1, mean_cases) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6c: Boxplot of new deaths based weighted on population density

p3 <- df %>%
  filter(rally_ind == 1) %>%
  filter(day_to_rally_1 %in% -21:21) %>%
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = mean(new_deaths_7dayavg_per_mil_cap, na.rm = T)) %>%
  ggplot(aes(x = factor(day_to_rally_1),
             y = new_deaths_7dayavg_per_mil_cap
             )) +
  geom_boxplot(fill = 'grey') +
  geom_vline(aes(xintercept = factor(0)),
                 colour = "red",
                 linetype = "dashed") +
  labs(title="Number of new confirmed COVID-19 deaths per million people",
       subtitle = "Weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

# Step 6d: Lineplot of new deaths for the mean weighted on population density

p4 <- df %>%
  filter(rally_ind == 1) %>% # counties with rallies
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(day_to_rally_1) %>%
  mutate(mean_cases = weighted.mean(new_deaths_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(day_to_rally_1, mean_cases) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 deaths per million people",
  subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") + ylim(0,4) +
  theme_bw()


p1
p2
p3
p4

```

Step 7: Propensity score matching

```{R}
# Step 7a: Propensity score matching based on median income and population density

score <- df %>% select(rally_ind,median_inc,density,fips)
score <- score %>% distinct()
score <- score %>% filter(!is.na(median_inc))
score <- score %>% filter(!is.na(density))
score <- score %>% filter(!is.infinite(density))

fit <- glm(rally_ind ~ median_inc + density, family="binomial" ,data=score)
summary(fit)

score$pr_score <- predict(fit, type = "response")

labs <- paste("County type:", c("Rally", "Control"))
score %>%
  mutate(rally_ind = ifelse(rally_ind == 1, labs[1], labs[2])) %>%
  ggplot(aes(x = pr_score)) +
  geom_histogram(color = "white") +
  facet_wrap(~rally_ind) +
  xlab("Probability of being a county with a rally") +
  theme_bw()

county_match <- matchit(rally_ind ~ median_inc + density , method ="nearest" ,data=score, replace = FALSE, ratio = 5)
dta_m <- match.data(county_match, subclass = "subclass")

summary(county_match)
dim(dta_m)

dta_m <- dta_m  %>% select(fips, subclass)
dta_m_1 <- inner_join(dta_m, df, by = c("fips"))


dta_m_2 <- dta_m_1  %>% select(day_to_rally_1, subclass, rally_ind, date)
dta_m_3 <- dta_m_2  %>% filter(rally_ind == 1)
dta_m_3 <- dta_m_3  %>% distinct()
dta_m_3 <- dta_m_3  %>% select(day_to_rally_1, subclass, date)


dta_m_1 <- dta_m_1 %>% select(c(1:18))%>% distinct()

dta_m <- full_join(dta_m_3, dta_m_1, by = c("subclass", "date"))

rm(dta_m_1)
rm(dta_m_2)
rm(dta_m_3)

```


Step 8: Mean-centered graphs of COVID-19 cases among counties with rallies vs. without

```{r}
# Step 8a:  Lineplot of new cases for the mean weighted on population density in case vs. control counties

p5 <- dta_m %>%
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  group_by(day_to_rally_1) %>%
    group_by(rally_ind) %>%
  mutate(mean_cases = weighted.mean(new_cases_7dayavg_per_mil_cap, density, na.rm = T)) %>% # weighted on population density
  select(rally_ind, day_to_rally_1, mean_cases) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = mean_cases,
             group = rally_ind)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Mean weighted on population density",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

p5

# Step 8b:  Lineplot of new cases, case vs. control counties

p6 <- dta_m %>%
  filter(day_to_rally_1 %in% -21:21) %>% # 3 weeks before and after
  select(rally_ind, day_to_rally_1, new_cases_7dayavg_per_mil_cap) %>% 
  distinct() %>%
  ggplot(aes(x = as.numeric(day_to_rally_1),
             y = new_cases_7dayavg_per_mil_cap,
             group = rally_ind)) +
  geom_line() +
  geom_vline(aes(xintercept = 0),
                 colour = "red",
                 linetype = "dashed") + 
  labs(title="Number of new confirmed COVID-19 cases per million people",
         subtitle = "Counties with rallies and matched control counties",
    x = "Days until/after rally", 
       y = "Rolling 7-day average") +
  theme_bw()

p6

```